@startuml
skinparam monochrome true
skinparam defaultFontName Courier
skinparam defaultFontSize 12
skinparam linetype ortho

start
:User request (e.g. "Dinner ~600 kcal, vegetarian");
:API -> RAG Controller;

if ("Recipe available in local DB?") then (Yes)
  :Retriever returns recipe + ingredients;
else (No)
  :Llama generates recipe draft;
endif

:Extract ingredient list;

repeat
  :Next ingredient;
  if ("Nutrition data cached (DB)?") then (Yes)
    :Read nutrition data from cache;
  else (No)
    :FDC / OFF API call;
    :Persist result in cache (DB);
  endif
repeat while (More ingredients?)

:Aggregate macros (kcal, protein, carbs, fat);
:Portioning logic\nadjusts to goal & daily balance;
:Format result (recipe + nutrition + notes);

stop
@enduml